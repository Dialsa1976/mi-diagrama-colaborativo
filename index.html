<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagrama Colaborativo</title>
    <style>
        #diagramContainer {
            width: 100%;
            height: 80vh;
            border: 1px solid #ccc;
        }
        #status {
            margin: 10px;
            font-weight: bold;
        }
    </style>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- Librer칤a correcta de Draw.io -->
    <script src="https://www.draw.io/embed.js"></script>
</head>
<body>
    <h2>Editor de Diagramas Colaborativo</h2>
    <div id="status">游리 Cargando...</div>
    <div id="diagramContainer"></div>

    <script>
        // Configuraci칩n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBGrtio9lIc922TT9KyC0nkG8mMYyheOHM",
            authDomain: "dislicores-app-bdf8c.firebaseapp.com",
            databaseURL: "https://dislicores-app-bdf8c-default-rtdb.firebaseio.com",
            projectId: "dislicores-app-bdf8c",
            storageBucket: "dislicores-app-bdf8c.firebasestorage.app",
            messagingSenderId: "245350083614",
            appId: "1:245350083614:web:ac48215a31500f0952920f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const diagramRef = db.ref('diagrama_colaborativo');

        let editor;
        let ignoreUpdates = false;

        function initEditor() {
            const container = document.getElementById('diagramContainer');

            // Inicializa el editor usando DrawioEmbed
            editor = new DrawioEmbed(container, {
                ui: 'min',
                zoom: '1',
                fit: '1',
                spin: '1',
                saveAndExit: false,
                lang: 'es',
                allowCustomPanels: false
            });

            // Evento cuando el editor est치 listo
            editor.addListener('init', () => {
                document.getElementById('status').textContent = "游릭 Editor listo";

                // Cargar datos desde Firebase
                diagramRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && !ignoreUpdates) {
                        editor.load(data.xml);
                    }
                });
            });

            // Guardar en Firebase cuando el usuario edite
            editor.addListener('save', (xml) => {
                if (!ignoreUpdates) {
                    document.getElementById('status').textContent = "游댃 Guardando...";
                    diagramRef.set({ xml }).then(() => {
                        document.getElementById('status').textContent = "游릭 Guardado y sincronizado";
                    });
                }
            });
        }

        // Esperar que la p치gina cargue antes de iniciar el editor
        window.addEventListener('DOMContentLoaded', initEditor);
    </script>
</body>
</html>
