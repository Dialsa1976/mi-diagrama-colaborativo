<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagrama Colaborativo</title>
    <style>
        #diagramFrame {
            width: 100%;
            height: 80vh;
            border: none;
        }
        #status {
            margin: 10px;
            font-weight: bold;
        }
    </style>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <h2>Editor de Diagramas Colaborativo</h2>
    <div id="status">游리 Cargando...</div>
    <iframe id="diagramFrame" src="https://www.draw.io/?embed=1&ui=min&lang=es"></iframe>

    <script>
        // Configuraci칩n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBGrtio9lIc922TT9KyC0nkG8mMYyheOHM",
            authDomain: "dislicores-app-bdf8c.firebaseapp.com",
            databaseURL: "https://dislicores-app-bdf8c-default-rtdb.firebaseio.com",
            projectId: "dislicores-app-bdf8c",
            storageBucket: "dislicores-app-bdf8c.firebasestorage.app",
            messagingSenderId: "245350083614",
            appId: "1:245350083614:web:ac48215a31500f0952920f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const diagramRef = db.ref('diagrama_colaborativo');

        let ignoreUpdates = false;
        const iframe = document.getElementById('diagramFrame');

        // Funci칩n para enviar mensajes al iframe
        function postMessageToEditor(action, data = {}) {
            iframe.contentWindow.postMessage(
                JSON.stringify({ action, ...data }),
                '*'
            );
        }

        // Escuchar eventos del iframe
        window.addEventListener('message', (event) => {
            const msg = JSON.parse(event.data);
            
            // Si el editor est치 listo
            if (msg.event === 'init') {
                document.getElementById('status').textContent = "游릭 Editor listo";

                // Cargar el diagrama desde Firebase
                diagramRef.once('value').then((snapshot) => {
                    const data = snapshot.val();
                    if (data && data.xml) {
                        postMessageToEditor('load', { xml: data.xml });
                    }
                });
            }

            // Si el usuario guarda cambios
            if (msg.event === 'save') {
                const xml = msg.xml;
                document.getElementById('status').textContent = "游댃 Guardando...";
                
                diagramRef.set({ xml }).then(() => {
                    document.getElementById('status').textContent = "游릭 Guardado y sincronizado";
                });
            }
        });

        // Enviar el comando de carga al iframe cuando est칠 listo
        iframe.onload = () => {
            document.getElementById('status').textContent = "游리 Cargando editor...";
        };
    </script>
</body>
</html>

